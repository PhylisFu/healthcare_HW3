---
title: "HW3 Group5"
author: "Tianyi Zhou, Mduduzi Langwenya, Shengchen Fu, Yanxi Gao, Lin Wang"
date: "2/22/2019"
output: word_document
---
```{r message=FALSE, warning=FALSE}
#load packages
library(tidyverse)
library(knitr)
library(readxl)
library(readr)
library(writexl)
#load revenue data
revenue<-read_csv("VTREVCODE16.csv")
#load ED emergency department data
ED<- read_csv("VTED16.csv")
#load inpatient data
inpatient<-read_csv("VTINP16_upd.csv")
```


###Question 1
####Select main variables from inpatient data to tell the stories
The stories of specific patients
UNIQ: 507033, 40436, 859382, 1585831, 200760, 3692, 690326

```{r}
# change the column Uniq into UNIQ in revenue data
revenue<-revenue %>% rename(UNIQ=Uniq)
str(revenue)
#select Unique number, hospital number, admission type, admission source, age, sex, discharge status, primary payer, charges, diagnosis, procedure and patient days columns in inpatient
inpatient_q1<-inpatient%>% select (UNIQ,hnum2,ATYPE,asour,intage,sex,dstat,PPAY,CHRGS,DX1,DX2,DX3,DX4,DX5,DX6,DX7,DX8,PX1,PX2,PX3,pdays) 
#select same columns in ED
ED_q1<-ED %>% select (UNIQ,hnum2,ATYPE,asour,intage,sex,dstat,PPAY,CHRGS,DX1,DX2,DX3,DX4,DX5,DX6,DX7,DX8,PX1,PX2,PX3,pdays) 
## We are doing this part in R because the file is big and it is faster to search for the patient in csv
## When patient went to ER first, their data can be found in both inpatient and ED data. 
#select unique number,revenue code, revenue charges, number of revenue units, CPT code columns in revenue
revenue_q1<-revenue %>% select(UNIQ,REVCODE,REVCHRGS,REVUNITS,CPT)

```

#####Patient 1
```{r}
#patient 507033
inpatient_q1 %>%  filter(UNIQ ==507033)
revenue_q1 %>% filter(UNIQ ==507033) %>% group_by(REVCODE) %>% arrange(desc(REVCHRGS))
```

#####Patient 2

```{r}
#patient 40436
inpatient_q1 %>%  filter(UNIQ ==40436) 
revenue_q1 %>% filter(UNIQ ==40436) %>% group_by(REVCODE) %>% arrange(desc(REVCHRGS))
```

#####Patient 3

```{r}
#patient 859382
inpatient_q1 %>%  filter(UNIQ ==859382)

ED_q1 %>% filter(UNIQ ==859382)

revenue_q1 %>% filter(UNIQ ==859382) %>% group_by(REVCODE) %>% arrange(desc(REVCHRGS))

```

#####Patient 4

```{r}
#patient 1585831
inpatient_q1 %>% filter(UNIQ ==1585831) 

ED_q1 %>%filter(UNIQ ==1585831) 

revenue_q1 %>% filter(UNIQ ==1585831) %>% group_by(REVCODE) %>% arrange(desc(REVCHRGS))
```

#####Patient 5

```{r}
#patient 200760
inpatient_q1 %>% filter(UNIQ ==200760) 

ED_q1 %>% filter(UNIQ ==200760) 

revenue_q1 %>% filter(UNIQ ==200760) %>% group_by(REVCODE) %>% arrange(desc(REVCHRGS))
```

#####Patient 6

```{r}
#patient 3692
inpatient_q1 %>%filter(UNIQ ==3692) 

ED_q1 %>% filter(UNIQ ==3692) 

revenue_q1 %>% filter(UNIQ ==3692) %>% group_by(REVCODE) %>% arrange(desc(REVCHRGS))
```

#####Patient 7

```{r}
#patient 690326
inpatient_q1 %>%  filter(UNIQ ==690326)

revenue_q1 %>% filter(UNIQ ==690326) %>% group_by(REVCODE) %>% arrange(desc(REVCHRGS))

```

###Question 2
```{r}
#select 3 major insurance payers
num=c(1,2,6,7)
inpatient_major = inpatient %>% filter(PPAY%in%num)
inpatient_major = inpatient_major %>% mutate(Payers = ifelse(PPAY==1,"MEDICARE",
                                     ifelse(PPAY==2,"MEDICAID","Commercial Payers")))
#create table
charge = inpatient_major %>% 
  group_by(Payers, MDC) %>% 
  summarise(Charges=round(sum(CHRGS)/1000000)) %>% 
  drop_na() #drop the rows where at least one column contains NA
cross_tab<-xtabs(Charges ~ Payers + MDC, data = charge)
cross_tab<-as.data.frame.matrix(cross_tab)




#age and sex for major payers
sex = inpatient_major %>% 
  group_by(Payers, sex) %>% 
  summarise(number=n()) %>% 
  drop_na()
age = inpatient_major %>% 
  group_by(Payers, intage) %>% 
  summarise(number=n()) %>% 
  drop_na()
age_sex = inpatient_major %>% 
  group_by(Payers, intage, sex) %>% 
  summarise(number=n()) %>% 
  drop_na()

#export data for piechart and tables
write_xlsx(x = charge, path = "charge.xlsx", col_names = TRUE)
write_xlsx(x = sex, path = "sex.xlsx", col_names = TRUE)
write_xlsx(x = age, path = "age.xlsx", col_names = TRUE)
write_xlsx(x = age_sex, path = "age_sex.xlsx", col_names = TRUE)
write_xlsx(x = cross_tab, path = "cross_tab", col_names = TRUE)
```

###Question 3
#### Reports all the details form the ED file for every emergency department admission that has identified the pt with at least one drug abuse related ICD-10 code 
```{r}
code = c("T40","T41","T42","T43")
drug_abuse<-ED %>% filter_at(vars(starts_with("DX")), any_vars(str_sub(., 1, 3) %in% code))
```

* 1 -	How many ED visits exactly have been diagnosed as drug user/abuser? 

```{r}
length(unique(drug_abuse$UNIQ))

```

* 2 -	There is a myth that the drug use/abuse has been a male problem and that women have much better protection measures to stay away from drug use/abuse let alone overdoses severe enough that lead to an ED admission. Can you check if your data supports this gender bias myth?  
```{r}
drug_abuse %>% group_by(sex) %>% summarise(n=n()) %>%drop_na()
```


* 3-	Tens of millions of dollars reportedly were spent on drug use related cases that year alone. Can you find the exact dollar amount for your identified patients? Of the three insurances in Question 1, what was share of each of the total payments?
```{r}
sum(drug_abuse$CHRGS)

num=c(1,2,6,7)
drug_abuse_major = drug_abuse %>% filter(PPAY%in%num)
drug_abuse_major = drug_abuse_major %>% mutate(Payers = ifelse(PPAY==1,"MEDICARE",
                                     ifelse(PPAY==2,"MEDICAID","Commercial Payers")))
drug_abuse_major %>% group_by(Payers) %>% summarise(sum=sum(CHRGS),ratio=sum/30741220)
```

* 4-	Recent breakthroughs in the dark side of chemistry of drug development have done nothing but damage to humanity. The use of synthetic narcotics is rising alarmingly in part due to the marketing campaign for such meds. On the other front the public is ill informed of the danger of those new generation of lab created drugs that are supposedly improving brainâ€™s performance (read more here or here). Use the ICD-10 codes of T404xxx and T4362xx to identify only a small sample of such patients. How many of patients have been brought to ED for diagnosis related to synthetic narcotics or amphetamines? 
```{r}
syn_narco<-drug_abuse %>% filter_at(vars(starts_with("DX")), any_vars(str_detect(., "^T404")|str_detect(.,"^T4362")))
```


* 5-	Name the 3 zip code regions with the highest rate of drug use/abuse. 
```{r}
drug_abuse %>% group_by(TXTZIP) %>% summarise(n=n()) %>% arrange(desc(n)) %>% top_n(3)
```

* 6-	What are the 10 most common diagnoses of drug use/abuse?


```{r message=TRUE, warning=TRUE}
code = c("T40","T41","T42","T43")
data<-data.frame(drug_abuse[,10:29])
list<-data %>% gather(key,value) %>% group_by(value) %>% tally  %>% filter(str_sub(value, 1, 3) %in% code) %>% arrange(desc(n)) 
list %>% top_n(10)
```


